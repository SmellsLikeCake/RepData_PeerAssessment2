---
title: "NOTES - US Storm Data Analysis"
author: "Helen"
date: "21 February 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

```{r, cache = TRUE}
noaa <- read.csv("StormData.csv.bz2")
str(noaa)
```

I also load the packages I may need.

```{r, warning = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)
library(lubridate)
```


## Ideas / Playing with Data

I tried putting the dates and times into a non-factor format but it was a pain in the butt due to missing data so decided it wasn't required.

The information I have been given states that we want to find out which events (in the EVTYPE variable) are most harmful to human health. However, there are 935 different types of events. I shall try to group these together to make the analysis more manageable.

Firstly, I know there are several types of "heat" - excessive heat, excess heat, heat etc. These also are responsible for all the incidences of a large number of deaths.

I will remove these into their own dataset and then create a remaining dataset without these.

```{r, cache = TRUE}
noaa_heatl <- grepl("heat", noaa$EVTYPE, ignore.case = TRUE)
noaa_heat <- noaa[noaa_heatl, ]
noaa_remain <- noaa[!noaa_heatl, ]
rm(noaa_heatl)
plot(noaa_heat$FATALITIES)
```

There are way too many of these. Let's look at the ones where people died.

```{r, cache = TRUE}
noaa_10f <- noaa[noaa$FATALITIES > 10, ]
summary(noaa_10f$EVTYPE)
```

This shows that incidents resulting in a high number of deaths only come from a few sources and a few of these are very similar (e.g. flood / flash flood).

Looking at those incidents that have killed at least 1 person:

```{r}
summary(noaa$EVTYPE[noaa$FATALITIES > 0])
```

The information I have been given states that we want to find out which events (in the EVTYPE variable) are most harmful to human health. However, there are 935 different types of events. I shall try to group these together to make the analysis more manageable.

I start by grouping everything the same way (as "Other") and then gradually identifying the top causes and categorising them.

Firstly let's manipulate the dates into Date format, add the extra column and then see what levels of fatalities the dataset includes.

```{r, cache = TRUE}
noaa <- tbl_df(noaa)
noaa$BGN_DATE <- as.Date(as.character(noaa$BGN_DATE), format = "%m/%d/%Y")
noaa <- mutate(noaa, EVTYPE_1 = "Other")
head(noaa$EVTYPE_1)
plot(noaa$FATALITIES)
```

50 looks like a good place to start.

```{r, cache = TRUE}
noaa_50f <- noaa[noaa$FATALITIES > 50, ]
noaa_50f <- droplevels(noaa_50f)
noaa_50f$EVTYPE
```

So there are four levels - three heats and one tornado. I'll add these categories.

```{r}
noaa$EVTYPE_1[grepl("heat", noaa$EVTYPE, ignore.case = TRUE)] <- "Hot weather"
noaa$EVTYPE_1[grepl("tornado", noaa$EVTYPE, ignore.case = TRUE)] <- "Tornado"
sum(noaa$EVTYPE_1 == "Heat")
```

So let's now plot the fatalities split by the EVTYPE.

```{r}
ggplot(noaa) + geom_point(aes(x = BGN_DATE, y = FATALITIES)) + facet_grid(. ~ EVTYPE_1)
```

Actually let's try a different graph where they're all on the same plot but the colours vary by type. That top heat one is also ruining the scales! I'm going to set the scales so it's not on the graph.

```{r}
ggplot(noaa) + geom_point(aes(x = BGN_DATE, y = FATALITIES, colour = EVTYPE_1)) + scale_y_continuous(limits = c(0, 200))
```

Okay that is interesting as we can see tornados reduce deaths caused over time but heat is increasing. 

Let's include a few more. Let's see what causes we have looking at events that caused between 10 and 50 deaths.

```{r, cache = TRUE}
noaa_10f <- noaa[noaa$FATALITIES > 10 & noaa$FATALITIES <= 50, ]
noaa_10f <- droplevels(noaa_10f)
levels(noaa_10f$EVTYPE)
```

Again we can group some of these together so we can add to our EVTYPE_1.

```{r}
noaa$EVTYPE_1[grepl("flood", noaa$EVTYPE, ignore.case = TRUE)] <- "Rain / Flood"
noaa$EVTYPE_1[grepl("rain", noaa$EVTYPE, ignore.case = TRUE)] <- "Rain / Flood"
noaa$EVTYPE_1[grepl("hurricane", noaa$EVTYPE, ignore.case = TRUE)] <- "Hurricanes / Storms"
noaa$EVTYPE_1[grepl("wind", noaa$EVTYPE, ignore.case = TRUE)] <- "Hurricanes / Storms"
noaa$EVTYPE_1[grepl("tide", noaa$EVTYPE, ignore.case = TRUE)] <- "Rain / Flood"

ggplot(noaa) + geom_point(aes(x = BGN_DATE, y = FATALITIES, colour = EVTYPE_1)) + scale_y_continuous(limits = c(0, 200))
```

Let's try another one where things with over 10 deaths automatically include EVTYPE but then we do some grouping too.

```{r}
noaa <- mutate(noaa, EVTYPE_2 = "Other")
noaa$EVTYPE_2[noaa$FATALITIES > 10] <- as.character(noaa$EVTYPE[noaa$FATALITIES > 10])

noaa$EVTYPE_2[grepl("heat", noaa$EVTYPE, ignore.case = TRUE)] <- "Heat"
noaa$EVTYPE_2[grepl("tornado", noaa$EVTYPE, ignore.case = TRUE)] <- "Tornado"
noaa$EVTYPE_2[grepl("flood", noaa$EVTYPE, ignore.case = TRUE)] <- "Rain / Flood"
noaa$EVTYPE_2[grepl("rain", noaa$EVTYPE, ignore.case = TRUE)] <- "Rain / Flood"
noaa$EVTYPE_2[grepl("hurricane", noaa$EVTYPE, ignore.case = TRUE)] <- "Hurricanes / Storms"
noaa$EVTYPE_2[grepl("wind", noaa$EVTYPE, ignore.case = TRUE)] <- "Hurricanes / Storms"
noaa$EVTYPE_2[grepl("tide", noaa$EVTYPE, ignore.case = TRUE)] <- "Rain / Flood"

ggplot(noaa) + geom_point(aes(x = BGN_DATE, y = FATALITIES, colour = EVTYPE_2)) + scale_y_continuous(limits = c(1, 200))
```

Have realised this method doesn't work as doesn't label anything with below 10 deaths even if same cause as an event above 10 deaths.

Back to original method.

```{r}
noaa$EVTYPE_1[grepl("warm", noaa$EVTYPE, ignore.case = TRUE)] <- "Hot weather"
noaa$EVTYPE_1[grepl("cold", noaa$EVTYPE, ignore.case = TRUE)] <- "Cold weather"
noaa$EVTYPE_1[grepl("storm", noaa$EVTYPE, ignore.case = TRUE)] <- "Hurricanes / Storms"
noaa$EVTYPE_1[grepl("tsunami", noaa$EVTYPE, ignore.case = TRUE)] <- "Tsunami"
noaa$EVTYPE_1[noaa$EVTYPE_1 == "Hurricane"] <- "Hurricanes / Storms"

ggplot(noaa) + geom_point(aes(x = BGN_DATE, y = FATALITIES, colour = EVTYPE_1)) + scale_y_continuous(limits = c(0, 200))
```

This might be easier to see with a stacked bar graph by year.

```{r}
noaa <- mutate(noaa, YEAR = year(BGN_DATE))
noaa_year_type <- group_by(noaa, YEAR, EVTYPE_1)
noaa_total_deaths <- summarise(noaa_year_type, total_deaths = sum(FATALITIES))
ggplot(noaa_total_deaths, aes(x = YEAR, y = total_deaths, fill = EVTYPE_1)) + geom_bar(stat = "identity") 

ggplot(noaa_total_deaths[noaa_total_deaths$YEAR > 1995, ], aes(x = YEAR, y = total_deaths, fill = EVTYPE_1)) + geom_bar(stat = "identity") 
```

We can see from this graph that it looks like complete data was not really collected until maybe 1994. Let's split into facets by type.

```{r}
ggplot(noaa_total_deaths[noaa_total_deaths$YEAR > 1995, ], aes(x = YEAR, y = total_deaths, fill = EVTYPE_1)) + geom_bar(stat= "identity") + facet_grid(EVTYPE_1~.)
```

This doesn't really work so we'll go back to stacked. Now we just want the levels in the right order.

```{r}
noaa_total_deaths$EVTYPE_1 <- factor(noaa_total_deaths$EVTYPE_1, levels = c("Other", "Tsunami", "Cold weather", "Hurricanes / Storms", "Rain / Flood", "Hot weather", "Tornado"))

ggplot(noaa_total_deaths[noaa_total_deaths$YEAR> 1990, ], aes(x = YEAR, y = total_deaths, fill = EVTYPE_1)) + geom_bar(stat = "identity") + geom_hline(aes(yintercept = mean(noaa_total_deaths$total_deaths[noaa_total_deaths$EVTYPE_1 == "Tornado"])))
```